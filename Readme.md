# Info API Kubernetes Release Manager

ะะธะฝะธะผะฐะปะธััะธัะฝัะน ะธะฝััััะผะตะฝั ะดะปั ะปะพะบะฐะปัะฝะพะณะพ ัะฟัะฐะฒะปะตะฝะธั ัะตะปะธะทะฐะผะธ ะฟัะธะปะพะถะตะฝะธั ะฒ Kubernetes-ะบะปะฐััะตัะต ั ะฟะพะผะพััั Bash-ัะบัะธะฟัะพะฒ.

---

## ๐ฆ ะ ะฟัะพะตะบัะต

ะญัะพั ัะตะฟะพะทะธัะพัะธะน ัะพะดะตัะถะธั:

- ะัะธะปะพะถะตะฝะธะต `info-api` ะฝะฐ FastAPI.
- ะกะบัะธะฟัั ะฐะฒัะพะผะฐัะธะทะฐัะธะธ ะฟัะพัะตััะฐ ัะตะปะธะทะพะฒ ะฒ Kubernetes.
- ะะพะดะดะตัะถะบั ัะฑะพัะบะธ ะฝะพะฒัั ัะตะปะธะทะพะฒ, ะฟะตัะตะบะปััะตะฝะธั ััะฐัะธะบะฐ, ะพัะบะฐัะฐ ะธ ัะธะฝะฐะปะธะทะฐัะธะธ.

**ะะดะตะฐะปัะฝะพ ะฟะพะดัะพะดะธั ะดะปั ะฟัะฐะบัะธะบะธ ะธ ะฟัะพัะพัะธะฟะธัะพะฒะฐะฝะธั CI/CD ะฟัะพัะตััะพะฒ.**

---

## ๐ ะขัะตะฑะพะฒะฐะฝะธั

- [Docker](https://www.docker.com/)
- [Kind](https://kind.sigs.k8s.io/) (Kubernetes in Docker)
- [kubectl](https://kubernetes.io/docs/tasks/tools/)
- Bash (ะตัะปะธ ะธัะฟะพะปัะทัะตัั Windows โ WSL ะธะปะธ Git Bash)

---

## ๐งฉ ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```plaintext
info-api/
โโโ app.py                   # ะัะธะปะพะถะตะฝะธะต FastAPI
โโโ Dockerfile               # ะกะฑะพัะบะฐ ะพะฑัะฐะทะฐ
โโโ active-release.txt       # ะะผั ัะตะบััะตะณะพ ะฐะบัะธะฒะฝะพะณะพ ัะตะปะธะทะฐ
โโโ deploys/                 # ะััะพัะธั YAML ัะฐะนะปะพะฒ ัะตะปะธะทะพะฒ
โโโ release.sh               # ะกะบัะธะฟั ัะฑะพัะบะธ ะธ ะฒัะบะปะฐะดะบะธ ะฝะพะฒะพะณะพ ัะตะปะธะทะฐ
โโโ switch.sh                # ะะตัะตะบะปััะตะฝะธะต ััะฐัะธะบะฐ ะฝะฐ ะฝะพะฒัะน ัะตะปะธะท
โโโ rollback.sh              # ะัะบะฐั ัะตะปะธะทะฐ ะฝะฐ ะฟัะตะดัะดััะธะน
โโโ finalize.sh              # ะะฐะฒะตััะตะฝะธะต ัะตะปะธะทะฐ ะธ ัะดะฐะปะตะฝะธะต ััะฐัะพะณะพ
```

---

## ๐ ะะฐะบ ะฟะพะปัะทะพะฒะฐัััั

### 1. ะะพะดะณะพัะพะฒะบะฐ ะบะปะฐััะตัะฐ

ะกะพะทะดะฐะน Kubernetes ะบะปะฐััะตั ัะตัะตะท Kind ั ะฝัะถะฝะพะน ะบะพะฝัะธะณััะฐัะธะตะน:

```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
    extraPortMappings:
      - containerPort: 30080
        hostPort: 30080
        protocol: TCP
  - role: worker
  - role: worker
```

ะกะพะทะดะฐะฝะธะต ะบะปะฐััะตัะฐ:

```bash
kind create cluster --name multi --config kind-config.yaml
```

ะกะพะทะดะฐะน ัะตัะฒะธั `info-api-service`:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: info-api-service
spec:
  type: NodePort
  selector:
    app: info-api
    release: v1
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
      nodePort: 30080
```

ะัะธะผะตะฝะตะฝะธะต:

```bash
kubectl apply -f info-api-service.yaml
```

---

### 2. ะัะฟััะบ ะฝะพะฒะพะณะพ ัะตะปะธะทะฐ

```bash
./release.sh v2
```

- ะกะพะฑะธัะฐะตััั Docker-ะพะฑัะฐะท `info-api:v2`.
- ะะฐะณััะถะฐะตััั ะฒ kind-ะบะปะฐััะตั.
- ะกะพะทะดะฐัััั ะฝะพะฒัะน Deployment `info-api-v2`.
- YAML ัะพััะฐะฝัะตััั ะฒ ะฟะฐะฟะบั `deploys/`.

---

### 3. ะะตัะตะบะปััะตะฝะธะต ััะฐัะธะบะฐ ะฝะฐ ะฝะพะฒัะน ัะตะปะธะท

```bash
./switch.sh v2
```

- ะกะตัะฒะธั `info-api-service` ะฟะตัะตะฝะฐัััะฐะธะฒะฐะตััั ะฝะฐ `release: v2`.
- ะะฑะฝะพะฒะปัะตััั ัะฐะนะป `active-release.txt`.

---

### 4. ะะฐะฒะตััะตะฝะธะต ัะตะปะธะทะฐ

```bash
./finalize.sh
```

- ะัะพะฒะตััะตััั, ััะพ ััะฐัะธะบ ะฝะฐะฟัะฐะฒะปะตะฝ ะฝะฐ ะฐะบัะธะฒะฝัะน ัะตะปะธะท.
- ะฃะดะฐะปััััั ะฒัะต ะดะตะฟะปะพะนะผะตะฝัั ะธ ะฟะพะดั ััะฐััะต ะฐะบัะธะฒะฝะพะณะพ ัะตะปะธะทะฐ.

---

### 5. ะัะบะฐั ัะตะปะธะทะฐ (ะตัะปะธ ััะพ-ัะพ ะฟะพัะปะพ ะฝะต ัะฐะบ)

```bash
./rollback.sh
```

- ะะตัะตะบะปััะตะฝะธะต ัะตัะฒะธัะฐ ะพะฑัะฐัะฝะพ ะฝะฐ ะฟัะตะดัะดััะธะน ัะตะปะธะท.
- ะฃะดะฐะปะตะฝะธะต ะฝะตัะดะฐัะฝะพะณะพ ะฝะพะฒะพะณะพ ัะตะปะธะทะฐ.

---

## ๐ ะัะธะผะตัั ัะฐะฑะพัะธั ัะตะฟะพัะตะบ

### ะะพะฒัะน ัะตะปะธะท

```bash
./release.sh v3
./switch.sh v3
./finalize.sh
```

### ะัะบะฐั ัะตะปะธะทะฐ

```bash
./rollback.sh
```

---

## ๐ ะะฐะถะฝะพ

- ะกะบัะธะฟัั ะฟะพะดะดะตัะถะธะฒะฐัั ัะตะผะฐะฝัะธะบั ะฒะตััะธะน ะฒะธะดะฐ `v1`, `v2`, `v3` ะธ ัะฐะบ ะดะฐะปะตะต.
- ะคะธะฝะฐะปะธะทะฐัะธั ะฒะพะทะผะพะถะฝะฐ ัะพะปัะบะพ ะตัะปะธ ััะฐัะธะบ ัะถะต ะฟะตัะตะฒะตะดัะฝ ะฝะฐ ะฝะพะฒัะน ัะตะปะธะท.
- ะัะต YAML'ั ะดะตะฟะปะพะนะผะตะฝัะพะฒ ัะพััะฐะฝััััั ะฒ `deploys/` ะดะปั ะธััะพัะธะธ.

---

## Gitlab pipeline

**โน๏ธ ะญัะพั ะฟัะพะตะบั ะธัะฟะพะปัะทัะตั ะฟะพะปะฝะพัััั ะฐะฒัะพะผะฐัะธะทะธัะพะฒะฐะฝะฝัะน ะฟะฐะนะฟะปะฐะนะฝ CI/CD ะดะปั ัะฟัะฐะฒะปะตะฝะธั ัะตะปะธะทะฐะผะธ FastAPI-ะฟัะธะปะพะถะตะฝะธั ะฒ Kubernetes ั ะฟะพะผะพััั GitLab Runner (Shell Executor) ะธ Kind-ะบะปะฐััะตัะฐ.**

**โน๏ธ [ะัะปะธ ัะพัะธัะต ัะทะฝะฐัั ะฟัะพ ะปะพะบะฐะปัะฝัั ัััะฐะฝะพะฒะบั Gitlab ะธ Gitlab Runner](https://github.com/Sharko-21/local-gitlab-installation)**
---

## ๐ ะกัััะบัััะฐ ะฟะฐะนะฟะปะฐะนะฝะฐ

```text
โโโโโโโโโโโโโโโโโโโโโโโโโ
โ      create-service   โ
โ (ะฟัะพะฒะตัะบะฐ ะธ ัะพะทะดะฐะฝะธะต   โ
โ    Kubernetes Service)โ
โโโโโโโโโโโโฌโโโโโโโโโโโโโ
           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโ
โ      build-release    โ
โ (ัะฑะพัะบะฐ ะพะฑัะฐะทะฐ,        โ
โ ะณะตะฝะตัะฐัะธั deploy YAML) โ
โ - artifacts: release_version.txt, deploys/ โ
โโโโโโโโโโโโฌโโโโโโโโโโโโโ
           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโ
โ     switch-traffic    โ
โ (ะพะฑะฝะพะฒะปะตะฝะธะต ัะตัะฒะธัะฐ ะฝะฐโ
โ   ะฝะพะฒัะน ัะตะปะธะท)         โ
โ - artifacts: active-release.txt โ
โโโโโโโโโโโโฌโโโโโโโโโโโโโ
           โผ
โโโโโโโโโโโโโโโโโโโโโโโโโ
โ     finalize-release  โ
โ (ัะดะฐะปะตะฝะธะต ััะฐััั       โ
โ deployment-ะพะฒ ะธ pod-ะพะฒ)โ
โโโโโโโโโโโโโโโโโโโโโโโโโ
```
---

### ๐ ะะดะต ะธัะบะฐัั ัะณะตะฝะตัะธัะพะฒะฐะฝะฝัะต YAML-ัะฐะนะปั?

- ะะพัะปะต ะฒัะฟะพะปะฝะตะฝะธั ััะฐะดะธะธ build-release, ัะณะตะฝะตัะธัะพะฒะฐะฝะฝัะต ัะฐะนะปั ัะพััะฐะฝััััั ะฒ ะฐััะตัะฐะบัะฐั ะฟะฐะนะฟะปะฐะนะฝะฐ (deploys/).
- ะั ะผะพะถะฝะพ ัะบะฐัะฐัั ะฒ GitLab UI ัะตัะตะท ะบะฝะพะฟะบั Download Artifacts.
- ะคะฐะนะปั ะธะผะตัั ะฒะธะด: deploys/info-api-<release>.yaml.

## ๐ ะะธัะตะฝะทะธั

ะกะฒะพะฑะพะดะฝะพ ะธัะฟะพะปัะทัะนัะต ะธ ะผะพะดะธัะธัะธััะนัะต ะฟัะพะตะบั ะดะปั ะปัะฑัั ัะตะปะตะน.

---

## โจ

ะัะพะตะบั ะฟะพัััะพะตะฝ ะฒ ััะตะฑะฝัั ัะตะปัั ะดะปั ะฟะพะฝะธะผะฐะฝะธั Kubernetes, ะฟัะพัะตััะพะฒ CI/CD ะธ ะฟัะฐะบัะธัะตัะบะพะณะพ ัะฟัะฐะฒะปะตะฝะธั ัะตะปะธะทะฐะผะธ.
